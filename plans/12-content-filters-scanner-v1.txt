 Plan: Integrate scan-v3 Content Filters and Optimizations into scan-v1                                                                                                                                                              │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ Based on my analysis, here's a comprehensive plan to integrate the scan-v3 optimizations into the current scan implementation:                                                                                                      │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ Current State Analysis                                                                                                                                                                                                              │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ scan-v1 (current):                                                                                                                                                                                                                  │ │
│ │ - Patterns compiled on every Scanner creation                                                                                                                                                                                       │ │
│ │ - Entropy using lazy_static but not fully optimized                                                                                                                                                                                 │ │
│ │ - Comment filtering embedded in scan logic                                                                                                                                                                                          │ │
│ │ - No prefiltering - all patterns run on every file                                                                                                                                                                                  │ │
│ │ - Line-by-line processing (now whole file after recent changes)                                                                                                                                                                     │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ scan-v3 (optimized):                                                                                                                                                                                                                │ │
│ │ - Patterns compiled once using LazyLock with Arc for zero-copy sharing                                                                                                                                                              │ │
│ │ - Entropy with pre-compiled regexes and static bigram sets                                                                                                                                                                          │ │
│ │ - Modular comment filter                                                                                                                                                                                                            │ │
│ │ - Aho-Corasick prefilter eliminates ~85% of patterns before regex execution                                                                                                                                                         │ │
│ │ - Optimized coordinate tracking                                                                                                                                                                                                     │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ Integration Plan                                                                                                                                                                                                                    │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ Phase 1: Pattern Library Optimization                                                                                                                                                                                               │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ 1. Create static pattern library (scan/patterns.rs):                                                                                                                                                                                │ │
│ │   - Move pattern compilation to LazyLock static initialization                                                                                                                                                                      │ │
│ │   - Use Arc for pattern names/descriptions (zero-copy)                                                                                                                                                                              │ │
│ │   - Pre-compile all regexes once at startup                                                                                                                                                                                         │ │
│ │   - Load patterns from embedded YAML file                                                                                                                                                                                           │ │
│ │ 2. Pattern structure changes:                                                                                                                                                                                                       │ │
│ │   - Add keywords field for Aho-Corasick prefiltering                                                                                                                                                                                │ │
│ │   - Add priority field for execution ordering                                                                                                                                                                                       │ │
│ │   - Use Arc wrappers for shared immutable data                                                                                                                                                                                      │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ Phase 2: Aho-Corasick Prefilter                                                                                                                                                                                                     │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ 1. Add prefilter module (scan/filters/content/prefilter.rs):                                                                                                                                                                        │ │
│ │   - Build Aho-Corasick automaton from pattern keywords                                                                                                                                                                              │ │
│ │   - Create keyword-to-pattern mapping                                                                                                                                                                                               │ │
│ │   - Return only active pattern indices (~15% of total)                                                                                                                                                                              │ │
│ │ 2. Integration:                                                                                                                                                                                                                     │ │
│ │   - Run prefilter before pattern matching                                                                                                                                                                                           │ │
│ │   - Only execute regex patterns that have keywords in content                                                                                                                                                                       │ │
│ │   - Sort active patterns by priority                                                                                                                                                                                                │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ Phase 3: Entropy Filter Optimization                                                                                                                                                                                                │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ 1. Optimize entropy module (scan/entropy.rs):                                                                                                                                                                                       │ │
│ │   - Replace lazy_static with LazyLock                                                                                                                                                                                               │ │
│ │   - Use Arc for shared regex patterns                                                                                                                                                                                               │ │
│ │   - Pre-compute bigram set with Arc wrapper                                                                                                                                                                                         │ │
│ │   - Cache character class ranges                                                                                                                                                                                                    │ │
│ │ 2. Key optimizations:                                                                                                                                                                                                               │ │
│ │   - Zero-copy access to static data                                                                                                                                                                                                 │ │
│ │   - No HashMap/HashSet creation per call                                                                                                                                                                                            │ │
│ │   - Reuse pre-compiled regexes                                                                                                                                                                                                      │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ Phase 4: Comment Filter Modularization                                                                                                                                                                                              │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ 1. Extract comment filter (scan/filters/content/comment.rs):                                                                                                                                                                        │ │
│ │   - Move ignore logic to separate filter                                                                                                                                                                                            │ │
│ │   - Parse all ignore directives at once                                                                                                                                                                                             │ │
│ │   - Return set of ignored line numbers                                                                                                                                                                                              │ │
│ │   - Filter matches post-processing                                                                                                                                                                                                  │ │
│ │ 2. Support multiple comment styles:                                                                                                                                                                                                 │ │
│ │   - //, #, <!-- -->, /* */                                                                                                                                                                                                          │ │
│ │   - Handle guardy:ignore, guardy:ignore-next, guardy:ignore-line                                                                                                                                                                    │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ Phase 5: Integration into scan_content()                                                                                                                                                                                            │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ 1. Update scan workflow:                                                                                                                                                                                                            │ │
│ │ // 1. Prefilter patterns with Aho-Corasick                                                                                                                                                                                          │ │
│ │ let active_patterns = prefilter.filter(content)?;                                                                                                                                                                                   │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ // 2. Execute only active patterns                                                                                                                                                                                                  │ │
│ │ let matches = execute_patterns(content, file_path, active_patterns)?;                                                                                                                                                               │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ // 3. Apply entropy filter                                                                                                                                                                                                          │ │
│ │ let matches = entropy_filter.filter(matches)?;                                                                                                                                                                                      │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ // 4. Apply comment filter                                                                                                                                                                                                          │ │
│ │ let matches = comment_filter.filter(matches, content)?;                                                                                                                                                                             │ │
│ │ 2. Coordinate tracking:                                                                                                                                                                                                             │ │
│ │   - Calculate line/column from byte positions                                                                                                                                                                                       │ │
│ │   - Use optimized coordinate system from scan-v3                                                                                                                                                                                    │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ Performance Benefits                                                                                                                                                                                                                │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ 1. Pattern Execution: ~85% reduction via Aho-Corasick prefiltering                                                                                                                                                                  │ │
│ │ 2. Memory: Zero-copy Arc sharing of all static data                                                                                                                                                                                 │ │
│ │ 3. Startup: One-time compilation cost, then free access                                                                                                                                                                             │ │
│ │ 4. Entropy: No allocation for bigram/regex checks                                                                                                                                                                                   │ │
│ │ 5. Overall: Expected 5-10x performance improvement                                                                                                                                                                                  │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ Implementation Order                                                                                                                                                                                                                │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ 1. Pattern library static compilation (highest impact)                                                                                                                                                                              │ │
│ │ 2. Aho-Corasick prefilter (biggest performance gain)                                                                                                                                                                                │ │
│ │ 3. Entropy optimization (moderate improvement)                                                                                                                                                                                      │ │
│ │ 4. Comment filter extraction (code organization)                                                                                                                                                                                    │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ Files to Modify/Create                                                                                                                                                                                                              │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ Create:                                                                                                                                                                                                                             │ │
│ │ - /scan/filters/content/mod.rs - Content filter module                                                                                                                                                                              │ │
│ │ - /scan/filters/content/prefilter.rs - Aho-Corasick implementation                                                                                                                                                                  │ │
│ │ - /scan/filters/content/comment.rs - Comment filter                                                                                                                                                                                 │ │
│ │ - /scan/static_patterns.rs - Static pattern library                                                                                                                                                                                 │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ Modify:                                                                                                                                                                                                                             │ │
│ │ - /scan/patterns.rs - Use static library instead of runtime compilation                                                                                                                                                             │ │
│ │ - /scan/entropy.rs - Optimize with LazyLock and Arc                                                                                                                                                                                 │ │
│ │ - /scan/core.rs - Integrate new filter pipeline                                                                                                                                                                                     │ │
│ │ - /scan/types.rs - Update structures for Arc usage                                                                                                                                                                                  │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ Testing Strategy                                                                                                                                                                                                                    │ │
│ │                                                                                                                                                                                                                                     │ │
│ │ 1. Benchmark before/after for performance validation                                                                                                                                                                                │ │
│ │ 2. Ensure all existing tests pass                                                                                                                                                                                                   │ │
│ │ 3. Add tests for prefilter accuracy                                                                                                                                                                                                 │ │
│ │ 4. Validate entropy threshold behavior unchanged                                                                                                                                                                                    │ │
│ │ 5. Test comment filtering across file types         